(function(f){function m(a){var d=a.split("/");return"_design"==d[0]?(d.shift(),"_design/"+encodeURIComponent(d.join("/"))):encodeURIComponent(a)}function g(a,d,e,b){var c,d=f.extend({successStatus:200},d),b=f.extend({contentType:"application/json",headers:{Accept:"application/json"}},b),e=e||"Unknown error";c=(new Date).getTime();f.ajax(f.extend(f.extend({type:"GET",dataType:"json",beforeSend:function(c){if(b&&b.headers)for(var a in b.headers)c.setRequestHeader(a,b.headers[a])},complete:function(b){var a=
(new Date).getTime()-c;try{var k=JSON.parse(b.responseText)}catch(f){if(d.error)d.error(b.status,b,f);else throw e+": "+f;return}d.ajaxStart&&d.ajaxStart(k);if(b.status==d.successStatus)d.beforeSuccess&&d.beforeSuccess(b,k,a),d.success&&d.success(k,a);else if(d.error)d.error(b.status,k&&k.error||e,k&&k.reason||"no response",a);else throw e+": "+k.reason;}},a),b))}function p(a){a=a||{};if("undefined"!==typeof a.ensure_full_commit){var d=a.ensure_full_commit;delete a.ensure_full_commit;return function(a){a.setRequestHeader("Accept",
"application/json");a.setRequestHeader("X-Couch-Full-Commit",d.toString())}}}function h(a){var d=[];if("object"===typeof a&&null!==a)for(var e in a)if(!(0<=f.inArray(e,["error","success","beforeSuccess","ajaxStart"]))){var b=a[e];0<=f.inArray(e,["key","startkey","endkey"])&&(b=j(b));d.push(encodeURIComponent(e)+"="+encodeURIComponent(b))}return d.length?"?"+d.join("&"):""}function j(a){return null!==a?JSON.stringify(a):null}f.couch=f.couch||{};var n=[];f.extend(f.couch,{urlPrefix:"",activeTasks:function(a){g({url:this.urlPrefix+
"/_active_tasks"},a,"Active task status could not be retrieved")},allDbs:function(a){g({url:this.urlPrefix+"/_all_dbs"},a,"An error occurred retrieving the list of all databases")},config:function(a,d,e,b){var c={url:this.urlPrefix+"/_config/"};d&&(c.url+=encodeURIComponent(d)+"/",e&&(c.url+=encodeURIComponent(e)));null===b?c.type="DELETE":void 0!==b&&(c.type="PUT",c.data=j(b),c.contentType="application/json",c.processData=!1);g(c,a,"An error occurred retrieving/updating the server configuration")},
session:function(a){a=a||{};g({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(d){var e=JSON.parse(d.responseText);if(200==d.status)a.success&&a.success(e);else if(a.error)a.error(d.status,e.error,e.reason);else throw"An error occurred getting session info: "+e.reason;}})},userDb:function(a){f.couch.session({success:function(d){d=f.couch.db(d.info.authentication_db);a(d)}})},signup:function(a,d,e){e=e||{};a.password=
d;a.roles=a.roles||[];a.type=a.type="user";a._id=a._id||"org.couchdb.user:"+a.name;f.couch.userDb(function(b){b.saveDoc(a,e)})},login:function(a){a=a||{};f.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:a.name,password:a.password},beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(d){var e=JSON.parse(d.responseText);if(200==d.status)a.success&&a.success(e);else if(a.error)a.error(d.status,e.error,e.reason);else throw"An error occurred logging in: "+
e.reason;}})},logout:function(a){a=a||{};f.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(a){a.setRequestHeader("Accept","application/json")},complete:function(d){var e=JSON.parse(d.responseText);if(200==d.status)a.success&&a.success(e);else if(a.error)a.error(d.status,e.error,e.reason);else throw"An error occurred logging out: "+e.reason;}})},db:function(a,d){var d=d||{},e={};return{name:a,uri:this.urlPrefix+"/"+encodeURIComponent(a)+
"/",compact:function(b){f.extend(b,{successStatus:202});g({type:"POST",url:this.uri+"_compact",data:"",processData:!1},b,"The database could not be compacted")},viewCleanup:function(b){f.extend(b,{successStatus:202});g({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},b,"The views could not be cleaned up")},compactView:function(b,c){f.extend(c,{successStatus:202});g({type:"POST",url:this.uri+"_compact/"+b,data:"",processData:!1},c,"The view could not be compacted")},create:function(b){f.extend(b,
{successStatus:201});g({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},b,"The database could not be created")},drop:function(b){g({type:"DELETE",url:this.uri},b,"The database could not be deleted")},info:function(b){g({url:this.uri},b,"Database information could not be retrieved")},changes:function(b,c){function a(){var d=f.extend({heartbeat:1E4},c,{feed:"longpoll",since:b});g({url:e.uri+"_changes"+h(d)},c,"Error connecting to "+e.uri+"/_changes.")}var c=c||{},d=100,
e=this,i=!0,l=[];c.success=function(c){d=100;i&&(b=c.last_seq,f.each(l,function(){this(c)}),a())};c.error=function(){i&&(setTimeout(a,d),d*=2)};b?a():e.info({success:function(c){b=c.update_seq;a()}});return{onChange:function(b){l.push(b)},stop:function(){i=!1}}},allDocs:function(b){var c="GET",a=null;b.keys&&(c="POST",a=b.keys,delete b.keys,a=j({keys:a}));g({type:c,data:a,url:this.uri+"_all_docs"+h(b)},b,"An error occurred retrieving a list of all documents")},allDesignDocs:function(b){this.allDocs(f.extend({startkey:"_design",
endkey:"_design0"},b))},allApps:function(b){var b=b||{},c=this;if(b.eachApp)this.allDesignDocs({success:function(d){f.each(d.rows,function(){c.openDoc(this.id,{success:function(c){var d,e,f=c._id.split("/");f.shift();f=f.join("/");(d=c.couchapp&&c.couchapp.index)?e=["",a,c._id,d].join("/"):c._attachments&&c._attachments["index.html"]&&(e=["",a,c._id,"index.html"].join("/"));e&&b.eachApp(f,e,c)}})})}});else throw"Please provide an eachApp function for allApps()";},openDoc:function(b,c,a){c=c||{};d.attachPrevRev||
c.attachPrevRev?f.extend(c,{beforeSuccess:function(b,c){e[c._id]={rev:c._rev,raw:b.responseText}}}):f.extend(c,{beforeSuccess:function(b,c){c["zepto.couch.attachPrevRev"]&&(e[c._id]={rev:c._rev,raw:b.responseText})}});g({url:this.uri+m(b)+h(c)},c,"The document could not be retrieved",a)},saveDoc:function(b,c){var c=c||{},a=this,d=p(c);if(void 0===b._id)var g="POST",i=this.uri;else g="PUT",i=this.uri+m(b._id);var l;if(b._id&&b._rev&&e[b._id]&&e[b._id].rev==b._rev){if("undefined"==typeof Base64)throw"Base64 support not found.";
b._attachments=b._attachments||{};b._attachments["rev-"+b._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(e[b._id].raw)};l=!0}else l=void 0;f.ajax({type:g,url:i+h(c),contentType:"application/json",dataType:"json",data:j(b),beforeSend:d,complete:function(d){var e=JSON.parse(d.responseText);if(200==d.status||201==d.status||202==d.status)b._id=e.id,b._rev=e.rev,l?a.openDoc(b._id,{attachPrevRev:!0,success:function(a){b._attachments=a._attachments;c.success&&c.success(e)}}):c.success&&
c.success(e);else if(c.error)c.error(d.status,e.error,e.reason);else throw"The document could not be saved: "+e.reason;}})},bulkSave:function(b,c){var a=p(c);f.extend(c,{successStatus:201,beforeSend:a});g({type:"POST",url:this.uri+"_bulk_docs"+h(c),contentType:"application/json",data:j(b)},c,"The documents could not be saved")},removeDoc:function(b,c){g({type:"DELETE",url:this.uri+m(b._id)+h({rev:b._rev})},c,"The document could not be deleted")},bulkRemove:function(b,c){b.docs=f.each(b.docs,function(b,
c){c._deleted=!0});f.extend(c,{successStatus:201});g({type:"POST",url:this.uri+"_bulk_docs"+h(c),data:j(b)},c,"The documents could not be deleted")},copyDoc:function(b,c,a){a=f.extend(a,{complete:function(b){var a=JSON.parse(b.responseText);if(201==b.status)c.success&&c.success(a);else if(c.error)c.error(b.status,a.error,a.reason);else throw"The document could not be copied: "+a.reason;}});g({type:"COPY",url:this.uri+m(b)},c,"The document could not be copied",a)},query:function(b,a,d,e){d=d||"javascript";
"string"!==typeof b&&(b=b.toSource?b.toSource():"("+b.toString()+")");b={language:d,map:b};null!=a&&("string"!==typeof a&&(a=a.toSource?a.toSource():"("+a.toString()+")"),b.reduce=a);g({type:"POST",url:this.uri+"_temp_view"+h(e),contentType:"application/json",data:j(b)},e,"An error occurred querying the database")},list:function(b,a,d,e){var b=b.split("/"),d=d||{},f="GET",i=null;d.keys&&(f="POST",i=d.keys,delete d.keys,i=j({keys:i}));g({type:f,data:i,url:this.uri+"_design/"+b[0]+"/_list/"+b[1]+"/"+
a+h(d)},e,"An error occured accessing the list")},view:function(b,a){var b=b.split("/"),a=a||{},d="GET",e=null;a.keys&&(d="POST",e=a.keys,delete a.keys,e=j({keys:e}));g({type:d,data:e,url:this.uri+"_design/"+b[0]+"/_view/"+b[1]+h(a)},a,"An error occurred accessing the view")},getDbProperty:function(a,c,d){g({url:this.uri+a+h(c)},c,"The property could not be retrieved",d)},setDbProperty:function(a,c,d,e){g({type:"PUT",url:this.uri+a+h(d),data:JSON.stringify(c)},d,"The property could not be updated",
e)}}},encodeDocId:m,info:function(a){g({url:this.urlPrefix+"/"},a,"Server information could not be retrieved")},replicate:function(a,d,e,b){b=f.extend({source:a,target:d},b);b.continuous&&!b.cancel&&(e.successStatus=202);g({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(b),contentType:"application/json"},e,"Replication failed")},newUUID:function(a){void 0===a&&(a=1);n.length||g({url:this.urlPrefix+"/_uuids",data:{count:a},async:!1},{success:function(a){n=a.uuids}},"Failed to retrieve UUID batch.");
return n.shift()}})})(Zepto);