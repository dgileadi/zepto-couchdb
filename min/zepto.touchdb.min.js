(function(f){function l(c){var d=c.split("/");return"_design"==d[0]?(d.shift(),"_design/"+encodeURIComponent(d.join("/"))):encodeURIComponent(c)}function e(c,d,e,a){var b,d=f.extend({successStatus:200},d),a=f.extend({contentType:"application/json",headers:{Accept:"application/json"}},a),e=e||"Unknown error";b=(new Date).getTime();f.ajax(f.extend(f.extend({type:"GET",dataType:"json",beforeSend:function(b){if(a&&a.headers)for(var h in a.headers)b.setRequestHeader(h,a.headers[h])},complete:function(a){var h=
(new Date).getTime()-b;try{var c=JSON.parse(a.responseText)}catch(f){if(d.error)d.error(a.status,a,f);else throw e+": "+f;return}d.ajaxStart&&d.ajaxStart(c);if(a.status==d.successStatus)d.beforeSuccess&&d.beforeSuccess(a,c,h),d.success&&d.success(c,h);else if(d.error)d.error(a.status,c&&c.error||e,c&&c.reason||"no response",h);else throw e+": "+c.reason;}},c),a))}function p(c){c=c||{};if("undefined"!==typeof c.ensure_full_commit){var d=c.ensure_full_commit;delete c.ensure_full_commit;return function(c){c.setRequestHeader("Accept",
"application/json");c.setRequestHeader("X-Couch-Full-Commit",d.toString())}}}function g(c){var d=[];if("object"===typeof c&&null!==c)for(var e in c)if(!(0<=f.inArray(e,["error","success","beforeSuccess","ajaxStart"]))){var a=c[e];0<=f.inArray(e,["key","startkey","endkey"])&&(a=j(a));d.push(encodeURIComponent(e)+"="+encodeURIComponent(a))}return d.length?"?"+d.join("&"):""}function j(c){return null!==c?JSON.stringify(c):null}f.couch=f.couch||{};var n=[];f.extend(f.couch,{urlPrefix:"http://localhost.touchdb.",
activeTasks:function(c){e({url:this.urlPrefix+"/_active_tasks"},c,"Active task status could not be retrieved")},allDbs:function(c){e({url:this.urlPrefix+"/_all_dbs"},c,"An error occurred retrieving the list of all databases")},db:function(c,d){var d=d||{},m={};return{name:c,uri:this.urlPrefix+"/"+encodeURIComponent(c)+"/",compact:function(a){f.extend(a,{successStatus:202});e({type:"POST",url:this.uri+"_compact",data:"",processData:!1},a,"The database could not be compacted")},viewCleanup:function(a){f.extend(a,
{successStatus:202});e({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},a,"The views could not be cleaned up")},compactView:function(a,b){f.extend(b,{successStatus:202});e({type:"POST",url:this.uri+"_compact/"+a,data:"",processData:!1},b,"The view could not be compacted")},create:function(a){f.extend(a,{successStatus:201});e({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},a,"The database could not be created")},drop:function(a){e({type:"DELETE",url:this.uri},
a,"The database could not be deleted")},info:function(a){e({url:this.uri},a,"Database information could not be retrieved")},changes:function(a,b){function c(){var h=f.extend({heartbeat:1E4},b,{feed:"longpoll",since:a});e({url:d.uri+"_changes"+g(h)},b,"Error connecting to "+d.uri+"/_changes.")}var b=b||{},h=100,d=this,i=!0,k=[];b.success=function(b){h=100;i&&(a=b.last_seq,f.each(k,function(){this(b)}),c())};b.error=function(){i&&(setTimeout(c,h),h*=2)};a?c():d.info({success:function(b){a=b.update_seq;
c()}});return{onChange:function(a){k.push(a)},stop:function(){i=!1}}},allDocs:function(a){var b="GET",c=null;a.keys&&(b="POST",c=a.keys,delete a.keys,c=j({keys:c}));e({type:b,data:c,url:this.uri+"_all_docs"+g(a)},a,"An error occurred retrieving a list of all documents")},allDesignDocs:function(a){this.allDocs(f.extend({startkey:"_design",endkey:"_design0"},a))},allApps:function(a){var a=a||{},b=this;if(a.eachApp)this.allDesignDocs({success:function(d){f.each(d.rows,function(){b.openDoc(this.id,{success:function(b){var d,
e,f=b._id.split("/");f.shift();f=f.join("/");(d=b.couchapp&&b.couchapp.index)?e=["",c,b._id,d].join("/"):b._attachments&&b._attachments["index.html"]&&(e=["",c,b._id,"index.html"].join("/"));e&&a.eachApp(f,e,b)}})})}});else throw"Please provide an eachApp function for allApps()";},openDoc:function(a,b,c){b=b||{};d.attachPrevRev||b.attachPrevRev?f.extend(b,{beforeSuccess:function(a,b){m[b._id]={rev:b._rev,raw:a.responseText}}}):f.extend(b,{beforeSuccess:function(a,b){b["zepto.couch.attachPrevRev"]&&
(m[b._id]={rev:b._rev,raw:a.responseText})}});e({url:this.uri+l(a)+g(b)},b,"The document could not be retrieved",c)},saveDoc:function(a,b){var b=b||{},c=this,d=p(b);if(void 0===a._id)var e="POST",i=this.uri;else e="PUT",i=this.uri+l(a._id);var k;if(a._id&&a._rev&&m[a._id]&&m[a._id].rev==a._rev){if("undefined"==typeof Base64)throw"Base64 support not found.";a._attachments=a._attachments||{};a._attachments["rev-"+a._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(m[a._id].raw)};
k=!0}else k=void 0;f.ajax({type:e,url:i+g(b),contentType:"application/json",dataType:"json",data:j(a),beforeSend:d,complete:function(d){var e=JSON.parse(d.responseText);if(200==d.status||201==d.status||202==d.status)a._id=e.id,a._rev=e.rev,k?c.openDoc(a._id,{attachPrevRev:!0,success:function(c){a._attachments=c._attachments;b.success&&b.success(e)}}):b.success&&b.success(e);else if(b.error)b.error(d.status,e.error,e.reason);else throw"The document could not be saved: "+e.reason;}})},bulkSave:function(a,
b){var c=p(b);f.extend(b,{successStatus:201,beforeSend:c});e({type:"POST",url:this.uri+"_bulk_docs"+g(b),contentType:"application/json",data:j(a)},b,"The documents could not be saved")},removeDoc:function(a,b){e({type:"DELETE",url:this.uri+l(a._id)+g({rev:a._rev})},b,"The document could not be deleted")},bulkRemove:function(a,b){a.docs=f.each(a.docs,function(a,b){b._deleted=!0});f.extend(b,{successStatus:201});e({type:"POST",url:this.uri+"_bulk_docs"+g(b),data:j(a)},b,"The documents could not be deleted")},
copyDoc:function(a,b,c){c=f.extend(c,{complete:function(a){var c=JSON.parse(a.responseText);if(201==a.status)b.success&&b.success(c);else if(b.error)b.error(a.status,c.error,c.reason);else throw"The document could not be copied: "+c.reason;}});e({type:"COPY",url:this.uri+l(a)},b,"The document could not be copied",c)},query:function(a,b,c,d){c=c||"javascript";"string"!==typeof a&&(a=a.toSource?a.toSource():"("+a.toString()+")");a={language:c,map:a};null!=b&&("string"!==typeof b&&(b=b.toSource?b.toSource():
"("+b.toString()+")"),a.reduce=b);e({type:"POST",url:this.uri+"_temp_view"+g(d),contentType:"application/json",data:j(a)},d,"An error occurred querying the database")},list:function(a,b,c,d){var a=a.split("/"),c=c||{},f="GET",i=null;c.keys&&(f="POST",i=c.keys,delete c.keys,i=j({keys:i}));e({type:f,data:i,url:this.uri+"_design/"+a[0]+"/_list/"+a[1]+"/"+b+g(c)},d,"An error occured accessing the list")},view:function(a,b){var a=a.split("/"),b=b||{},c="GET",d=null;b.keys&&(c="POST",d=b.keys,delete b.keys,
d=j({keys:d}));e({type:c,data:d,url:this.uri+"_design/"+a[0]+"/_view/"+a[1]+g(b)},b,"An error occurred accessing the view")},getDbProperty:function(a,b,c){e({url:this.uri+a+g(b)},b,"The property could not be retrieved",c)},setDbProperty:function(a,b,c,d){e({type:"PUT",url:this.uri+a+g(c),data:JSON.stringify(b)},c,"The property could not be updated",d)}}},encodeDocId:l,info:function(c){e({url:this.urlPrefix+"/"},c,"Server information could not be retrieved")},replicate:function(c,d,g,a){a=f.extend({source:c,
target:d},a);a.continuous&&!a.cancel&&(g.successStatus=202);e({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(a),contentType:"application/json"},g,"Replication failed")},newUUID:function(c){void 0===c&&(c=1);n.length||e({url:this.urlPrefix+"/_uuids",data:{count:c},async:!1},{success:function(c){n=c.uuids}},"Failed to retrieve UUID batch.");return n.shift()}})})(Zepto);